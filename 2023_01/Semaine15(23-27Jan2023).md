**23 Janvier**
- [x] Réponse aux demandes nulles d'Evelyne sur les excel monteurs
- [ ] Objectif du jour : Réaliser un docker file / docker compose qui lance un keycloak / angular simple
    - [x] Rectifier l'écriture du dockerfile angular
        - [x] Rebuild de l'image & tentative de run
    - [x] Reprise de doc
        - [x] Check de (https://github.com/andreaskring/fastapi-keycloak-angular/blob/master/docker-compose.yml)
        - [x] Check de doc docker (https://docs.docker.com/get-started/09_image_best/) & (https://docs.docker.com/get-started/08_using_compose/) & (https://docs.docker.com/get-started/07_multi_container/)
- [ ] Reprise étape par étape
    - [x] Suivi de projet de (https://github.com/andreaskring/fastapi-keycloak-angular/tree/master/angular) pour comparaison
    - [ ] Modification de l'architecture pour correspondre
        - [x] Reprise du dockerfile angular : 
        ```
        # syntax=docker/dockerfile:1
        FROM node:18-alpine

        WORKDIR /app-angular-keycloak
        # WORKDIR /

        ENV PATH /app-angular-keycloak/node_modules/.bin:$PATH

        # install and cache app dependencies
        # COPY package.json .
        # RUN npm install
        # RUN npm install -g @angular/cli@7.3.9

        COPY ./app-angular-keycloak/package.json ./
        COPY ./app-angular-keycloak/package-lock.json ./
        RUN npm install

        COPY ./angular ./
        RUN npm run build
        ```
        - [ ] Réorganisation du projet
            - [x] Création d'un dossier docker
            - [x] Renommage du dockerfile en Dockerfile.angular et déplacement dans le dossier docker             
        - [x] Lancement de la commande ``` docker build -t templategithubactionsAngular .``` et echec avec message :
        ```
        invalid argument "templategithubactionsAngular" for "-t, --tag" flag: invalid reference format: repository name must be lowercase
        ```
        - [x] Lancement de la commande rectifiée ``` docker build -t templategithubactionsangular .```  et echec avec message 
        ```
        unable to prepare context: unable to evaluate symlinks in Dockerfile path: CreateFile C:\Users\gchevalier\TemplateGitHubActions\docker\Dockerfile: The system cannot find the file specified.
        ```
        - [x] Check de (https://stackoverflow.com/questions/35511604/docker-unable-to-prepare-context-unable-to-evaluate-symlinks-in-dockerfile-pa) et précision avec -f du nomp exact avec file ext
        - [x] Check de (https://docs.docker.com/engine/context/working-with-contexts/) pour comprendre comment aller dire où chercher le package.json quand il est dans un autre dossier & (https://stackoverflow.com/questions/72650546/docker-build-command-cant-find-package-json) pour plus de compréhension du contexte et de son application dans le docker compose
        - [x] Retour dans le dossier racine et lancement de la commande rectifiée ```docker build -t templategithubactionsangular -f ./docker/Dockerfile.angular .```  et build successful
        - [x] Note : dans le dockerfile : ```COPY ./app-angular-keycloak/package.json ./``` ne va pas chercher depuis le dossier racine, mais depuis le dossier *d'où est lancée la commande docker!*
        - [ ] Run de l'image buildée avec ```docker run --name leisure-goat -dp 3000:3000 templategithubactionsangular``` et echec avec retour console :
        ```
        Error: This command is not available when running the Angular CLI outside a workspace.
        The command '/bin/sh -c npm run build' returned a non-zero code: 1
        ```
    - [ ] Voir comment organiser les images avec le docker compose


**24 Janvier**
- [ ] Objectif du jour : réaliser un lancement opérationnel de docker/keycloak/angular depuis un docker-compose
    - [x] Check du realm.json de keycloak dans le projet exemple
    - [ ] Générer un json à partir de l'état d'un keycloak
        - [ ] Check de (https://www.keycloak.org/server/importExport)
    - [ ] Création d'un dockerfile postgresql
        - [x] Check de (https://dev.to/andre347/how-to-easily-create-a-postgres-database-in-docker-4moj)
        - [x] Possibilié de run la base avec la commande ```docker run --name postgres-db -e POSTGRES_PASSWORD=docker -p 5432:5432 -d postgres```. Test en lançant la commande depuis le dossier racine : container créé et fonctionnel
        - [x] Écriture d'un dockerfile :
        ```
        FROM postgres
        ENV POSTGRES_PASSWORD pw123
        ENV POSTGRES_DB testgreg1
        COPY testgreg1.sql /docker-entrypoint-initdb.d/
        ```
        - [x] Création d'un fichier sql testgreg1 (pour correspondre à ```COPY testgreg1.sql```) en se basant sur () :
        ```
        -- PostgreSQL port of the MySQL "testgreg1" database.
        --

        BEGIN;

        SET client_encoding = 'LATIN1';

        -- Table structure for table `testgreg1`
        --

        CREATE TABLE IF NOT EXISTS `testgreg1` (
        `user_id` int(11) NOT NULL AUTO_INCREMENT,
        `username` varchar(255) DEFAULT NULL,
        `first_name` varchar(50) DEFAULT NULL,
        `last_name` varchar(50) DEFAULT NULL,
        `gender` varchar(10) DEFAULT NULL,
        `password` varchar(50) DEFAULT NULL,
        `status` tinyint(10) DEFAULT NULL,
        PRIMARY KEY (`user_id`)
        ) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=10001 ;

        -- Dumping data for table `testgreg1`

        INSERT INTO `testgreg1` (`user_id`, `username`, `first_name`, `last_name`, `gender`, `password`, `status`) VALUES
        (1, 'rogers63', 'david', 'john', 'Female', 
        ...
        (10, 'morgan65', 'paul', 'miller', 'Female', 'a28dca31f5aa5792e1cefd1dfd098569', 1);
        ```
        - [x] Lancement de ```docker build -t templategithubactionspostgresql -f ./docker/Dockerfile.postgresql .``` à la racine du projet : build successful
        - [x] Lancement du run : ```docker run -d --name postgresdb-container -p 5432:5432 templategithubactionspostgresql``` run successful
    - [ ] Reprise du dockerfile angular pour que le run ng serve soit fonctionnel
        - [x] Ajout de :
        ```
        RUN cd ./app-angular-keycloak
        RUN npm run build
        ```
        mais message d'erreur : 
        ```
        /bin/sh: cd: line 0: can't cd to ./app-angular-keycloak: No such file or directory
        The command '/bin/sh -c cd ./app-angular-keycloak' returned a non-zero code: 2
        ```
    - [ ] Reprise du dockerfile keycloak pour prise en compte des paramètres du container postgresql
        - [x] Check de (https://keycloak.discourse.group/t/how-to-set-database-address/14600) & (https://keycloak.ch/keycloak-tutorials/tutorial-custom-keycloak/) & (https://www.keycloak.org/server/all-config?f=config)
        - [x] Modifications apportées aux paramètres :
        ```
        ENV KC_DB_URL=postgresdb-container:3306/keycloak
        ENV KC_DB_USERNAME=testgreg1
        ENV KC_DB_PASSWORD=pw123
        ENV KC_HOSTNAME=localhost
        ENTRYPOINT ["/opt/keycloak/bin/kc.sh"]
        ```
        - [x] Rebuild avec commande ```docker build -t templategithubactionskeycloak -f ./docker/Dockerfile.keycloak .``` : build successful
        - [x] Run avec commande ```docker run --name keycloak-container -dp 8080:8080 templategithubactionskeycloak```
    - [ ] Reprise de doc sur docker-compose
        - [ ] Check de (https://docs.docker.com/compose/compose-file/)
- [ ] Résolution du problème de mail J.Ivanoff
    - [x] Envoi d'un mail de demande de précisions
    - [x] Échange de mail et envoi du tuto pdf 
- [x] Information Frank : le certificat lets encrypt d'atmos est valable 3 mois, renouvelé par un script.
    - [x] Recherches sur let's encrypt & les certificats associés
        - [x] Check de (https://letsencrypt.org/fr/getting-started/) & (https://letsencrypt.org/fr/certificates/)
        - [x] Rédaction du retour de veille sur letsencrypt pour assimilation
- [x] Note personnelle, keycloak utilise JDBC : Java Data Base Connectivity
- [x] Check de la relaation entre github actions et un dockerfile (https://docs.github.com/en/actions/creating-actions/dockerfile-support-for-github-actions)
- [x] Ajout de la ligne 
```
ENV POSTGRES_USER keycloak
```
dans le Dockerfile.postgresql pour coller aux infos dans le docker-compose
- [x] Rebuild et run de l'image postgresql
- [x] Configuration de postgres dans le docker-compose :
```
  postgres:
    container_name: postgresdb-container
    image: templategithubactionspostgresql
    environment:
      POSTGRES_DB: testgreg1
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: pw123
    volumes:
      - type: volume
        source: postgres-volume
        target: /var/lib/postgresql/data
    ports:
      -"5432:5432"
```
- [x] Mise en commentaires du reste du fichier docker-compose
- [x] Tentative de docker compose up, retour console :
```
service "postgres" refers to undefined volume postgres-volume: invalid compose project
```
- [x] Résolution de l'erreur
    - [x] Check de (https://stackoverflow.com/questions/69867166/undefined-volume-with-docker-compose) & (https://github.com/compose-spec/compose-spec/blob/master/spec.md#volumes-top-level-element)
    - [x] Mise en commentaires de la partie volume : retour console :
    ``` 
    Error response from daemon: Conflict. 
    The container name "/postgresdb-container" is already in use by container "ba414e74216aff58794ae42837760ae1c3624629584b26e9bf773fa935a8deae". 
    You have to remove (or rename) that container to be able to reuse that name.
    ```
    - [x] Suppression du container dans docker desktop, relance de la commande et build successful !
- [ ] Couplage postgres/keycloak via docker compose