**22 Septembre**
- [ ] ESL   
    - [x] Reprise et mise à jour jira
    - [x] 
    - [x] Repasse sur dev
    ```
    git checkout develop
    git pull
    ```
    - [x] Nouvelle branche ```git checkout -b fix/ESL-430+_various_qol_improvements```
        - [ ] ESL-437 Lever une snackbar d'erreur quand on essaie de créer un template sans renseigner les dimensions & ESL-436 Lever une snackbar d'erreur quand on essaie de créer un template sans nom
            - [x] ```docker compose  --env-file .env.dev -f docker-compose.api.yml up --build```
            - [x] fichier add-template-modal.component.ts, refonte de la fonction onSubmit() :
            ```
            OnSubmit() {
                if (!this.name || this.name.trim() === '') {
                this.snackBar.open('Le champ "Nom" est obligatoire', 'Fermer', {
                    duration: 3000,
                    panelClass: ['error-snackbar']
                });
                return;
                }

                if (!this.templateSize.value) {
                this.snackBar.open('Veuillez sélectionner une dimension', 'Fermer', {
                    duration: 3000,
                    panelClass: ['error-snackbar']
                });
                return;
                }

                const styleName = this.styleNameControl.value;
                const [width, height] = this.templateSize.value.split('x').map(Number);

                this.templateService
                .checksIfExistsByWidthHeightAndStyle(width, height, styleName)
                .subscribe((exists) => {
                    if (exists) {
                    this.snackBar.open(
                        'Un template existe déjà pour ce style avec ces dimensions',
                        'Fermer',
                        { duration: 3000, panelClass: ['error-snackbar'] }
                    );
                    } else {
                    this.redirectToCreate();
                    }
                });
            }
            ```
        - [ ] ESL-430 Harmoniser les tableaux des modales dashboard en ag-grid

**23 Septembre**
- [ ] ESL   
    - [ ] ESL-430 Harmoniser les tableaux des modales dashboard en ag-grid
        - [ ] esl-list-dialog.component.html
        ```
        <div class="container mx-auto p-4">
        <div class="grid grid-cols-1 justify-items-end mr-4">
            <button
            mat-dialog-close
            class="text-red-500 text-4xl cursor-pointer hover:text-red-700"
            aria-label="Fermer">
            ×
            </button>
        </div>

        <h2 class="text-2xl font-bold mb-4 text-gray-800">Liste des ESLs</h2>

        <div class="ag-theme-alpine" style="height: 600px; width: 100%;">
            <ag-grid-angular
            #agGrid
            class="ag-theme-alpine"
            [rowData]="data.esl"
            [columnDefs]="columnDefs"
            [defaultColDef]="defaultColDef"
            [gridOptions]="gridOptions"
            (gridReady)="onGridReady($event)">
            </ag-grid-angular>
        </div>
        </div>
        ```
        - [ ] esl-list-dialog.component.ts
        ```
        import { Component, Inject, ViewChild } from '@angular/core';
        import { MAT_DIALOG_DATA, MatDialog } from '@angular/material/dialog';
        import { EslService } from '../../../services/esl.service';
        import { MatSnackBar } from '@angular/material/snack-bar';
        import { TemplateService } from '../../../services/template-service';
        import { AgGridAngular } from 'ag-grid-angular';
        import { ColDef, GridOptions, GridReadyEvent, ICellRendererParams } from 'ag-grid-community';
        import { ModuleRegistry, AllCommunityModule } from 'ag-grid-community';
        import * as fabric from 'fabric';

        @Component({
        selector: 'app-esl-list-dialog',
        standalone: true,
        imports: [AgGridAngular],
        templateUrl: './esl-list-dialog.component.html',
        styleUrls: ['./esl-list-dialog.component.scss']
        })
        export class EslListDialogComponent {
        @ViewChild(AgGridAngular) agGrid!: AgGridAngular;
        currentEslId: string | null = null;
        readonly dialog = Inject(MatDialog);

        
        columnDefs: ColDef[] = [
            {
            headerName: 'ESL ID',
            field: 'id_esl',
            sortable: true,
            filter: true,
            cellClass: 'break-words'
            },
            {
            headerName: 'Fournisseur',
            field: 'supplier',
            sortable: true,
            filter: true
            },
            {
            headerName: 'Largeur',
            field: 'width',
            sortable: true,
            filter: true
            },
            {
            headerName: 'Hauteur',
            field: 'height',
            sortable: true,
            filter: true
            },
            {
            headerName: 'Puissance',
            field: 'power',
            sortable: true,
            filter: true
            },
            {
            headerName: 'Modèle',
            field: 'version_name',
            sortable: true,
            filter: true
            },
            {
            headerName: 'Actions',
            cellRenderer: this.actionCellRenderer.bind(this),
            autoHeight: true,
            cellClass: 'flex items-center gap-2'
            },
            {
            headerName: 'Prévisualisation',
            cellRenderer: this.previewCellRenderer.bind(this),
            autoHeight: true,
            cellClass: 'p-2'
            }
        ];

        gridOptions: GridOptions = {
            domLayout: 'autoHeight',
            suppressHorizontalScroll: true,
            rowHeight: 80, 
            onRowDataUpdated: () => {
            if (this.agGrid?.api) {
                this.agGrid.api.sizeColumnsToFit();
            }
            }
        };

        defaultColDef: ColDef = {
            sortable: true,
            filter: true,
            resizable: true,
        };

        constructor(
            @Inject(MAT_DIALOG_DATA) public data: { esl: any[] },
            private eslService: EslService,
            private snackBar: MatSnackBar,
            private templateService: TemplateService
        ) {
            ModuleRegistry.registerModules([AllCommunityModule]);
        }

        
        actionCellRenderer(params: ICellRendererParams) {
            const button = document.createElement('button');
            button.innerHTML = 'Clignoter';
            button.className = 'bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600';
            button.addEventListener('click', () => {
            this.blinkEsl(params.data.id_esl, this.encodeColor('#00FF00'));
            });
            return button;
        }

        
        previewCellRenderer(params: ICellRendererParams) {
            const container = document.createElement('div');
            container.className = 'preview-box';
            container.innerHTML = `
            <canvas id="previewCanvas-${params.data.id_esl}" width="200" height="100"></canvas>
            `;
            container.addEventListener('mouseenter', () => {
            this.showPreview(params.data.id_esl);
            });
            container.addEventListener('mouseleave', () => {
            this.hidePreview();
            });
            return container;
        }

        blinkEsl(id_esl: string, color: string) {
            this.eslService.blinkEsl(id_esl, color).subscribe({
            next: () => {
                this.snackBar.open(
                `ESL ${id_esl} clignote en ${color}`,
                'Fermer',
                { duration: 2000 }
                );
            },
            error: (error) => {
                console.error(error);
                this.snackBar.open(
                `Erreur lors du clignotement de l'ESL ${id_esl}`,
                'Fermer',
                { duration: 2000 }
                );
            }
            });
        }

        encodeColor(color: string): string {
            return encodeURIComponent(color);
        }

        showPreview(id_esl: string) {
            this.currentEslId = id_esl;
            this.templateService.getTemplateByEslId(id_esl).subscribe({
            next: (template) => {
                if (template?.objects) {
                this.renderTemplateOnCanvas(template.objects, id_esl);
                }
            },
            error: (error) => {
                console.error(error);
            }
            });
        }

        hidePreview() {
            this.currentEslId = null;
            const canvas = document.getElementById(`previewCanvas-${this.currentEslId}`) as HTMLCanvasElement;
            if (canvas) {
            const fabricCanvas = new fabric.Canvas(canvas);
            fabricCanvas.clear();
            }
        }

        renderTemplateOnCanvas(objects: any[], id_esl: string) {
            const canvasElement = document.getElementById(`previewCanvas-${id_esl}`) as HTMLCanvasElement;
            if (!canvasElement) return;

            const canvas = new fabric.Canvas(canvasElement);
            canvas.clear();
            objects.forEach((obj) => {
            let fabricObject;
            if (obj.type === 'IText') {
                fabricObject = new fabric.IText(obj.text, {
                ...obj,
                left: 10,
                top: 10
                });
            }/* else if (obj.type === 'Image') {
                fabricObject = new fabric.Image.fromURL(obj.src, (img) => {
                img.set(obj);
                canvas.add(img);
                canvas.renderAll();
                });
            }*/
            if (fabricObject && obj.type !== 'Image') {
                canvas.add(fabricObject);
            }
            });
            canvas.renderAll();
        }

        onGridReady(params: GridReadyEvent) {
            params.api.sizeColumnsToFit();
        }
        }
        ```
    - [ ] add-template-modal.component.html
    ```
    <div class="flex justify-end mb-4">
        <button
        (click)="onClose()"
        class="text-red-500 text-4xl cursor-pointer hover:text-red-700"
        aria-label="Fermer la modale">
        ×
        </button>
    </div>

    <h2 class="text-2xl font-bold mb-6 text-gray-800">ESLs non associées</h2>

    <div class="relative" style="height: 500px; width: 100%;">
        <div *ngIf="isLoading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-70 z-10">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>

        <ag-grid-angular
        #agGrid
        class="ag-theme-alpine h-full w-full"
        [rowData]="eslsWithoutStoreArticle"
        [columnDefs]="columnDefs"
        [defaultColDef]="defaultColDef"
        [gridOptions]="gridOptions"
        (gridReady)="onGridReady($event)">
        </ag-grid-angular>
    </div>
    </div>
    ```
    - [ ] add-template-modal.component.ts
    ```
    if (!this.name || this.name.trim() === '') {
    this.snackBar.open('Le champ "Nom" est obligatoire', 'Fermer', {
        duration: 3000,
        panelClass: ['error-snackbar']
    });
    return;
    }

    if (!this.templateSize.value) {
    this.snackBar.open('Veuillez sélectionner une dimension', 'Fermer', {
        duration: 3000,
        panelClass: ['error-snackbar']
    });
    return;
    }
    this.templateService
        .checksIfExistsByWidthHeightAndStyle(width, height, styleName)
        .subscribe((exists) => {
            if (exists) {
            this.snackBar.open(
                'Un template existe déjà pour ce style avec ces dimensions',
                'Fermer',
                { duration: 3000, panelClass: ['error-snackbar'] }
            );
            } else {
            this.redirectToCreate();
            }
        });
    }
    ```
    - [x] ```git add . git push```

**24 Septembre**
- [ ] ESL   
    - [ ] ESL-438 Fix l'affichage des storeArticles dans la modale dashboard
        - [x] Retour d'erreur : 
        ```
       repsonse au lieu de response
        ```
        - [x] Fix : 
            - [x] dashboard component
            ```
            openStoreArticleModal() {
                this.dialog.open(StoreArticleListDialogComponent, {
                width: '80%',
                height: '700px',
                maxWidth: 'none',
                data: { response: this.allStoreArticles.items }
                });
            }
            ```
    - [ ] ESL-390 FEATURE DEMO ONLY : Créer un bouton de création de StoreArticle dans la page StoreArticleTable
    - [ ] ESL-405-406 
        - [ ] Créer une fonction pour autogénérer un template de base par dimension pour un style donné
        - [ ] A la création d'un style, ajouter une boîte de dialogue demandant si oui ou non on veut autogénérer un template de base par dimension pour ce style

**25 Septembre**
- [ ] ESL   
    - [ ] ESL-405-406 
        - [ ] Créer une fonction pour autogénérer un template de base par dimension pour un style donné
        - [ ] A la création d'un style, ajouter une boîte de dialogue demandant si oui ou non on veut autogénérer un template de base par dimension pour ce style