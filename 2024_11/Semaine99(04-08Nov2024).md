**04 Novembre**
- [ ] ESL
    - [ ] ESL-147 Mettre à jour les ESLs en fournissant un fichier en entrée
        - [ ] ESL-152 Créer le front pour recharger toutes les ESLs
            - [ ] Merge de la branche 133 dans ma 147   
                - [x] ```git pull origin ESL-133```   
                - [ ] Résolution des conflits
            - [ ] Créer la logique front pour recharger toutes les ESLs
            - [ ] Tout refaire sur le back 
                - [x] Enoyer les données du csv dans le back
                    - [x] Modif du component front : 
                    ```
                      handleFileInput(event: Event): void {
                        const inputElement = event.target as HTMLInputElement;
                        if (inputElement.files && inputElement.files.length > 0) {
                        const file = inputElement.files[0];
                        if (file) {
                            this.parseCSVAndSendToBackend(file);
                        }
                        }
                    }

                    parseCSVAndSendToBackend(file: File): void {
                        Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (result) => {
                            this.csvData = result.data;
                            console.table(this.csvData);
                            this.storeArticleService.processCsvData(this.csvData).subscribe(
                            response => console.log('CSV processed successfully', response),
                            error => console.error('Error processing CSV:', error)
                            );
                        }
                        });
                    }
                    ```
                    - [x] Ajout de méthode dans le service front article component
                    ```
                    processCsvData(data: any[]): Observable<any> {
                        return this.httpClient.post(`${this.apiUrl}/process-csv-data`, data);
                    }
                    ```
                    - [x] Ajout dans le backend du store article controller:
                    ```
                    @Get('barcode/:barcode')
                    findOneByBarcode(@Param('barcode') barcode: string) {
                        return this.storeArticlesService.findOneByBarcode(barcode);
                    }

                    @Get(':id/esl')
                    async getEsl(@Param('id') id: string) {
                        return await this.storeArticlesService.getEslByStoreArticleId(+id);
                    }

                    @Post('process-csv-data')
                    async processCsvData(@Body() csvData: any[]): Promise<any> {
                        return await this.storeArticlesService.processCsvData(csvData);
                    }
                    ```
                    - [x] Ajout dans le backend du store article service:
                    ```
                    async processCsvData(csvData: any[]): Promise<any> {
                        const results = [];
                    
                        for (const row of csvData) {
                        const { bar_code, price } = row;
                        if (!bar_code || !price) continue;
                    
                        try {
                            const storeArticle = await this.findOneByBarcode(bar_code);
                    
                            if (!storeArticle) {
                            console.warn(`Store article with barcode ${bar_code} not found`);
                            continue;
                            }
                    
                            const esl = await this.getEslByStoreArticleId(storeArticle.id);
                    
                            if (!esl) {
                            console.warn(`No ESL associated with store article ${storeArticle.id}`);
                            continue;
                            }
                    
                            const template = await this.templateService.getTemplateByEslId(esl.id_esl);
                    
                            if (template && template.objects.length > 0) {
                            const firstObject = template.objects[0];
                            if (firstObject.text === "$price$") {
                                firstObject.text = price;
                                
                                await this.updateTemplateAndSendImage(esl.id_esl, template);
                                results.push({ bar_code, status: "Updated", eslId: esl.id_esl });
                            }
                            }
                        } catch (error) {
                            console.error(`Error processing barcode ${bar_code}:`, error);
                            results.push({ bar_code, status: "Error", error: error.message });
                        }
                        }
                    
                        return results;
                    }

                    private async updateTemplateAndSendImage(eslId: string, template: any) {
                        await this.templateService.updateTemplate(eslId, template);
                    
                        const imagePath = `/app/src/store-articles/image/${template.name}.jpg`;
                        if (fs.existsSync(imagePath)) {
                        const imageBuffer = fs.readFileSync(imagePath);
                        const imageBase64 = imageBuffer.toString('base64');
                    
                        await this.httpService.post('http://mqtt_api:5002/esl_set_image', { id_esl: eslId, image: imageBase64 }).toPromise();
                        console.log(`Image sent for ESL ID ${eslId}`);
                        }
                    }
                    ```
                    - [x] Ajout dans le backend du template service:
                    ```
                    async getTemplateByEslId(eslId: string): Promise<Template> {
                        return this.findByEslId(eslId);
                    }
                    
                    async updateTemplate(eslId: string, updateData: Partial<Template>): Promise<Template> {
                        return this.templateModel.findOneAndUpdate({ esl_id: eslId }, updateData, { new: true }).exec();
                    }
                    ```
                - [X] Reprendre la logique dans le back 
                - [ ] Générer l'image, utiliser le service base64 et envoyer à l'ESL
                    - [x] Installation de : 
                    ```
                    npm install fabric canvas node-fetch --legacy-peer-deps
                    ```
                    - [x] Ajout dans le service de : 
                - [ ] transformer en base64 & envoyer


**05 Novembre**
- [ ] ESL
    - [ ] ESL-147 Mettre à jour les ESLs en fournissant un fichier en entrée
        - [ ] ESL-152 Créer le front pour recharger toutes les ESLs 
            - [x] Lint
            - [ ] Testing backend
                - [x] template controller
                - [x] StoreArticlesController
                - [x] template service
                - [x] StoreArticles service


**06 Novembre**
- [ ] ESL
    - [ ] ESL-147 Mettre à jour les ESLs en fournissant un fichier en entrée
        - [ ] ESL-152 Créer le front pour recharger toutes les ESLs 
            - [x] Lint
            - [ ] Testing front
                - [ ] create new template component
                - [ ] template editor component
                - [ ] edit template component
                - [ ] create new template component